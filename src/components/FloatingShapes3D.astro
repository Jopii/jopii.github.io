---
// FloatingShapes3D.astro - Figura 3D individual con Three.js
interface Props {
  class?: string;
  shape?: 'icosahedron' | 'torus' | 'sphere' | 'cylinder';
  color?: string;
}

const { 
  class: className = "", 
  shape = 'icosahedron',
  color = '#f472b6'
} = Astro.props;
---

<div class={`floating-3d-container ${className}`} data-shape={shape} data-color={color}>
  <canvas class="floating-shapes-canvas"></canvas>
</div>

<script>
  import * as THREE from 'three';

  document.addEventListener('DOMContentLoaded', () => {
    const containers = document.querySelectorAll('.floating-3d-container');
    
    containers.forEach((container) => {
      const canvas = container.querySelector('.floating-shapes-canvas');
      if (!canvas) return;

      const shapeType = container.getAttribute('data-shape') || 'icosahedron';
      const colorHex = container.getAttribute('data-color') || '#f472b6';
      const color = parseInt(colorHex.replace('#', '0x'));

      // Configurar escena
      const scene = new THREE.Scene();
      const camera = new THREE.PerspectiveCamera(50, 1, 0.1, 100);
      camera.position.z = 5;

      // Renderer
      const renderer = new THREE.WebGLRenderer({ 
        canvas, 
        alpha: true, 
        antialias: true 
      });
      
      // Tamaño responsive
      const isMobile = window.innerWidth < 768;
      const size = isMobile ? 80 : 100;
      renderer.setSize(size, size);
      renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));

      // Crear geometría según tipo
      let geometry, mesh;
      
      const material = new THREE.MeshPhysicalMaterial({
        color: color,
        metalness: 0.2,
        roughness: 0.3,
        clearcoat: 0.5,
        clearcoatRoughness: 0.2
      });

      switch(shapeType) {
        case 'torus':
          geometry = new THREE.TorusGeometry(0.5, 0.2, 16, 50);
          break;
        case 'sphere':
          geometry = new THREE.SphereGeometry(0.55, 32, 32);
          break;
        case 'cylinder':
          geometry = new THREE.CylinderGeometry(0.4, 0.4, 0.9, 32);
          break;
        case 'icosahedron':
        default:
          geometry = new THREE.IcosahedronGeometry(0.6, 1);
          break;
      }

      mesh = new THREE.Mesh(geometry, material);
      scene.add(mesh);

      // Iluminación
      const ambientLight = new THREE.AmbientLight(0xffffff, 0.7);
      scene.add(ambientLight);

      const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
      directionalLight.position.set(3, 5, 5);
      scene.add(directionalLight);

      const pointLight = new THREE.PointLight(color, 0.5, 10);
      pointLight.position.set(-2, 2, 3);
      scene.add(pointLight);

      // Animación
      let animationId;
      let isVisible = true;
      
      const animate = () => {
        if (!isVisible) return;
        animationId = requestAnimationFrame(animate);
        
        // Rotación suave
        mesh.rotation.x += 0.005;
        mesh.rotation.y += 0.007;
        
        // Flotación suave
        const time = Date.now() * 0.001;
        mesh.position.y = Math.sin(time) * 0.1;

        renderer.render(scene, camera);
      };

      animate();

      // Pausar cuando no es visible
      const observer = new IntersectionObserver((entries) => {
        entries.forEach((entry) => {
          isVisible = entry.isIntersecting;
          if (isVisible) {
            animate();
          } else {
            cancelAnimationFrame(animationId);
          }
        });
      }, { threshold: 0.1 });
      
      observer.observe(container);

      // Resize handler
      window.addEventListener('resize', () => {
        const newIsMobile = window.innerWidth < 768;
        const newSize = newIsMobile ? 80 : 100;
        renderer.setSize(newSize, newSize);
      });
    });
  });
</script>

<style>
  .floating-3d-container {
    width: 100px;
    height: 100px;
    position: relative;
    pointer-events: none;
  }
  
  .floating-shapes-canvas {
    width: 100% !important;
    height: 100% !important;
    display: block;
  }
  
  @media (max-width: 768px) {
    .floating-3d-container {
      width: 80px;
      height: 80px;
    }
  }
</style>
